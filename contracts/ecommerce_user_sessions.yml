version: "1.0.0"
dataset: "ecommerce_user_sessions"
stage: "silver"
owner: "ecommerce-analytics-team"
description: "Cleansed user session data with behavioral metrics"

schema:
  columns:
    - name: session_id
      type: VARCHAR
      nullable: false
      description: "Unique session identifier"
      constraints:
        - unique: true
        - not_null: true
    - name: user_id
      type: VARCHAR
      nullable: true
      description: "User identifier (null for anonymous)"
    - name: session_start
      type: TIMESTAMP
      nullable: false
      description: "Session start timestamp"
      constraints:
        - not_null: true
    - name: session_end
      type: TIMESTAMP
      nullable: false
      description: "Session end timestamp"
      constraints:
        - not_null: true
    - name: duration_seconds
      type: INTEGER
      nullable: false
      description: "Session duration in seconds"
      constraints:
        - min_value: 0
        - max_value: 86400
    - name: page_views
      type: INTEGER
      nullable: false
      description: "Number of pages viewed"
      constraints:
        - not_null: true
        - min_value: 1
    - name: products_viewed
      type: INTEGER
      nullable: false
      description: "Number of unique products viewed"
      constraints:
        - min_value: 0
    - name: cart_adds
      type: INTEGER
      nullable: false
      description: "Number of items added to cart"
      constraints:
        - min_value: 0
    - name: conversion_flag
      type: BOOLEAN
      nullable: false
      description: "Whether session resulted in purchase"
    - name: total_revenue
      type: DECIMAL
      nullable: true
      description: "Total revenue from session (null if no purchase)"
      constraints:
        - min_value: 0
    - name: device_type
      type: VARCHAR
      nullable: false
      description: "Device type used"
      constraints:
        - allowed_values: ["mobile", "tablet", "desktop"]
    - name: traffic_source
      type: VARCHAR
      nullable: false
      description: "Traffic source"
      constraints:
        - allowed_values: ["organic", "paid", "social", "direct", "email", "referral"]

quality_rules:
  - name: "no_duplicate_sessions"
    type: "uniqueness"
    column: "session_id"
    severity: "error"
  - name: "valid_session_duration"
    type: "custom_sql"
    query: "SELECT COUNT(*) FROM {dataset} WHERE session_end < session_start"
    expected: 0
    severity: "error"
  - name: "conversion_requires_revenue"
    type: "custom_sql"
    query: "SELECT COUNT(*) FROM {dataset} WHERE conversion_flag = true AND (total_revenue IS NULL OR total_revenue = 0)"
    expected: 0
    severity: "error"
  - name: "non_conversion_no_revenue"
    type: "custom_sql"
    query: "SELECT COUNT(*) FROM {dataset} WHERE conversion_flag = false AND total_revenue IS NOT NULL"
    expected: 0
    severity: "error"
  - name: "minimum_sessions"
    type: "volume"
    min_rows: 1
    severity: "error"

sla:
  freshness:
    max_age_hours: 2
    schedule: "hourly"
  completeness:
    min_row_count: 100

evolution:
  backward_compatible: true
  breaking_changes_allowed: false
