version: "1.0.0"
dataset: "ecommerce_customer_lifetime_value"
stage: "gold"
owner: "ecommerce-growth-team"
description: "Customer lifetime value and behavioral segmentation"

schema:
  columns:
    - name: user_id
      type: VARCHAR
      nullable: false
      description: "Unique user identifier"
      constraints:
        - unique: true
        - not_null: true
    - name: first_purchase_date
      type: DATE
      nullable: false
      description: "Date of first purchase"
      constraints:
        - not_null: true
    - name: last_purchase_date
      type: DATE
      nullable: false
      description: "Date of most recent purchase"
      constraints:
        - not_null: true
    - name: total_orders
      type: INTEGER
      nullable: false
      description: "Total number of orders"
      constraints:
        - min_value: 1
    - name: total_revenue
      type: DECIMAL
      nullable: false
      description: "Total revenue from customer"
      constraints:
        - min_value: 0
    - name: average_order_value
      type: DECIMAL
      nullable: false
      description: "Average order value"
      constraints:
        - min_value: 0
    - name: total_sessions
      type: INTEGER
      nullable: false
      description: "Total number of sessions"
      constraints:
        - min_value: 1
    - name: conversion_rate
      type: DECIMAL
      nullable: false
      description: "Overall conversion rate (0-1)"
      constraints:
        - min_value: 0
        - max_value: 1
    - name: days_since_last_purchase
      type: INTEGER
      nullable: false
      description: "Days since last purchase"
      constraints:
        - min_value: 0
    - name: customer_lifetime_value
      type: DECIMAL
      nullable: false
      description: "Predicted lifetime value"
      constraints:
        - min_value: 0
    - name: customer_segment
      type: VARCHAR
      nullable: false
      description: "Customer segmentation"
      constraints:
        - allowed_values: ["high_value", "medium_value", "low_value", "at_risk", "churned"]
    - name: preferred_device
      type: VARCHAR
      nullable: false
      description: "Most used device type"

quality_rules:
  - name: "no_duplicate_users"
    type: "uniqueness"
    column: "user_id"
    severity: "error"
  - name: "first_before_last_purchase"
    type: "custom_sql"
    query: "SELECT COUNT(*) FROM {dataset} WHERE first_purchase_date > last_purchase_date"
    expected: 0
    severity: "error"
  - name: "valid_conversion_rate"
    type: "custom_sql"
    query: "SELECT COUNT(*) FROM {dataset} WHERE conversion_rate > 1 OR conversion_rate < 0"
    expected: 0
    severity: "error"
  - name: "minimum_customers"
    type: "volume"
    min_rows: 1
    severity: "error"

sla:
  freshness:
    max_age_hours: 24
    schedule: "daily"
  completeness:
    min_row_count: 10

evolution:
  backward_compatible: true
  breaking_changes_allowed: false
