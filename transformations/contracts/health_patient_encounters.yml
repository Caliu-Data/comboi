version: "1.0.0"
dataset: "health_patient_encounters"
stage: "silver"
owner: "healthcare-data-team"
description: "Cleansed patient encounter records with quality validations"

schema:
  columns:
    - name: encounter_id
      type: VARCHAR
      nullable: false
      description: "Unique encounter identifier"
      constraints:
        - unique: true
        - not_null: true
    - name: patient_id
      type: VARCHAR
      nullable: false
      description: "Patient identifier (anonymized)"
      constraints:
        - not_null: true
    - name: encounter_date
      type: DATE
      nullable: false
      description: "Date of encounter"
      constraints:
        - not_null: true
    - name: encounter_type
      type: VARCHAR
      nullable: false
      description: "Type of clinical encounter"
      constraints:
        - allowed_values: ["inpatient", "outpatient", "emergency", "telehealth", "surgery"]
    - name: primary_diagnosis
      type: VARCHAR
      nullable: false
      description: "Primary ICD-10 diagnosis code"
      constraints:
        - not_null: true
        - pattern: "^[A-Z][0-9]{2}.*"
    - name: length_of_stay_days
      type: INTEGER
      nullable: true
      description: "Length of stay in days (null for outpatient)"
      constraints:
        - min_value: 0
        - max_value: 365
    - name: total_charges
      type: DECIMAL
      nullable: false
      description: "Total charges for encounter"
      constraints:
        - not_null: true
        - min_value: 0
    - name: discharge_status
      type: VARCHAR
      nullable: true
      description: "Patient discharge status"
      constraints:
        - allowed_values: ["home", "transferred", "deceased", "left_ama", "hospice"]

quality_rules:
  - name: "no_duplicate_encounters"
    type: "uniqueness"
    column: "encounter_id"
    severity: "error"
  - name: "valid_patient_ids"
    type: "not_null"
    column: "patient_id"
    severity: "error"
  - name: "valid_icd10_format"
    type: "custom_sql"
    query: "SELECT COUNT(*) FROM {dataset} WHERE primary_diagnosis !~ '^[A-Z][0-9]{2}'"
    expected: 0
    severity: "error"
  - name: "reasonable_charges"
    type: "custom_sql"
    query: "SELECT COUNT(*) FROM {dataset} WHERE total_charges > 1000000"
    expected: 0
    severity: "warning"
  - name: "inpatient_must_have_los"
    type: "custom_sql"
    query: "SELECT COUNT(*) FROM {dataset} WHERE encounter_type = 'inpatient' AND length_of_stay_days IS NULL"
    expected: 0
    severity: "error"
  - name: "minimum_encounters"
    type: "volume"
    min_rows: 1
    severity: "error"

sla:
  freshness:
    max_age_hours: 24
    schedule: "daily"
  completeness:
    min_row_count: 10

evolution:
  backward_compatible: true
  breaking_changes_allowed: false
  deprecation_notice_days: 90
